#!/bin/zsh

# Make sure the alias is not active
unalias gbc 2>/dev/null

gbc() {
  echo "Refreshing local branch list..."
  git remote update origin --prune &>/dev/null

  local current_branch=$(git branch --show-current)
  local needs_switch=false

  # Check if current branch is merged (and not main)
  if [[ "$current_branch" != "main" ]] && git branch --merged | grep -q "^[* ]*${current_branch}$"; then
    needs_switch=true
  fi

  # Check if current branch is gone
  if git branch -v | grep "^\* " | grep -q " \[gone\] "; then
    needs_switch=true
  fi

  # Switch to main if current branch will be cleaned up
  if [[ "$needs_switch" == true ]]; then
    echo "Current branch '$current_branch' will be cleaned up, switching to main..."
    git checkout main
  fi

  echo "Cleaning merged branches"
  git branch --merged | grep -v 'main$' | xargs git branch -d 2>/dev/null
  
  echo "Cleaning gone branches"
  for x in $(git branch -v | grep " \[gone\] " | awk '{print $1}')
  do
    git branch -D "$x"
  done
}

kill_sidekiq() {
  echo "Killing Sidekiq without waiting for jobs to finish..."
  ps -ef | grep sidekiq | grep -v grep | awk '{print $2}' | xargs kill -9
}
